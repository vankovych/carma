<!DOCTYPE html>
<html>
    <head>
        <title>eleks Career Map</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="css/vendor/normalize.css">
        <link rel="stylesheet" href="css/style.css">

        <script src="js/libs/d3/d3.js"></script>
        <!--<script src="js/libs/jquery/jquery-2.1.4.min.js"></script>-->

        <script src="js/app/main.js"></script>
    </head>
    <body>
        <div id="container">
            <div class="menu">
                <h3><a href="#">eleks Career map</a></h3>
                <ul>
                    <li><a href="#" class="active">Career opportunities</a></li>
                    <li><a href="#">Discovery positions</a></li>
                </ul>
            </div>
            <div id="map">
                <svg></svg>
            </div>
        </div>
        <script>
            'use strict';

            var CM = {
                svgWidth: 1000,
                svgHeight: 900,
                R: 300,
                arcTween: function (transition, newAngleS, newAngleE) {
                    transition.attrTween("d", function (d) {

                        var interpolateS = d3.interpolate(d.startAngle, newAngleS),
                                interpolateE = d3.interpolate(d.endAngle, newAngleE);

                        return function (t) {
                            d.startAngle = interpolateS(t);
                            d.endAngle = interpolateE(t);

                            return CM.arc(d);
                        };
                    });
                }
            };

            CM.P = Math.PI * 2;
            CM.ArcLen = CM.P / 20;
            CM.ArcMargin = CM.P / 400;

            // Arc function
            CM.arc = d3.svg.arc()
                    .startAngle(function (d) {
                        return d.startAngle;
                    })
                    .endAngle(function (d) {
                        return d.endAngle;
                    })
                    .innerRadius(CM.R - 10)
                    .outerRadius(CM.R + 7);

            var division;

            d3.json('data.json', function (error, json) {
                if (error) {
                    return console.warn(error);
                }

                var divisions = json.divisions;

                division = divisions[0];

                divisions.forEach(function (d, i) {
                    d.i = i++;
                    d.startAngle = CM.ArcLen * i;
                    d.endAngle = CM.ArcLen * (i + 1) - CM.ArcMargin;
                });

                CM.svg = d3.select('#map svg')
                        .attr('width', CM.svgWidth)
                        .attr('height', CM.svgHeight);
                CM.group = CM.svg.append('g')
                        .attr('transform', 'translate(' + CM.svgWidth / 2 + ', ' + CM.svgHeight / 2 + ')');

                CM.group.append('circle')
                        .attr('cx', 0)
                        .attr('cy', 0)
                        .attr('class', 'circle-main-in')
                        .attr('r', CM.R - 7);

                // render placeholder
                CM.group.selectAll('path.placeholder')
                        .data(divisions).enter()
                        .append('path')
                        .attr('d', CM.arc)
                        .attr('class', 'placeholder');

                // render divisions
                CM.group.selectAll('path.division')
                        .data(divisions).enter()
                        .append('path')
                        .attr('id', function (d) {
                            return d.id;
                        })
                        .attr('d', CM.arc)
                        .attr('cx', 100)
                        .attr('class', 'division')
                        .attr('fill', function (d) {
                            return d.color;
                        })
                        .on('click', moveArc);

                // render text
                CM.group.selectAll('g')
                        .data(divisions).enter()
                        .append('g')
                        .attr('id', function (d) {
                            return d.id + '-title';
                        })
                        .attr('transform', function (d) {
                            return "rotate(" + ((d.startAngle + CM.ArcLen / 2) * (180 / Math.PI) - 90) + ")translate(" + 300 + ')';
                        })
                        .style('opacity', 1)
                        .append('text')
                        .attr('class', 'division-title')
                        .attr('dx', function (d) {
                            return d.startAngle * (180 / Math.PI) < 180 ? 15 : -15;
                        })
                        .attr('dy', '.31em')
                        .attr('text-anchor', function (d) {
                            return d.startAngle * (180 / Math.PI) < 180 ? 'start' : 'end';
                        })
                        .attr('transform', function (d) {
                            return d.startAngle * (180 / Math.PI) < 180 ? null : 'rotate(180)';
                        })
                        .text(function (d) {
                            return d.title;
                        });

                CM.group.append('line')
                        .attr('class', 'ololo')
                        .attr('x1', -CM.R + 5)
                        .attr('y1', 0)
                        .attr('x2', -150)
                        .attr('y2', 0)
                        .attr('stroke-width', 1)
                        .attr('stroke', '#DC8B8A');

                var pos = [1, 2, 3, 4, 5, 6];

                CM.group.selectAll('circle.position')
                        .data(pos).enter()
                        .append('circle')
                        .attr('class', 'position')
                        .attr('cx', function (d) {
                            return -CM.R + 25 * d;
                        })
                        .attr('cy', 0)
                        .attr('r', 7)
                        .style('fill', '#DC8B8A');
            });

            function moveArc() {

                var root = this;

                // tmp
                var ang = (0.78 * CM.P - CM.ArcLen / 2) * (180 / Math.PI);

                // fade in all divisions except for selected
                CM.group.selectAll('.division')
                        .transition()
                        .duration(500)
                        .style('opacity', function () {
                            return (this.id === root.id) ? .8 : 0;
                        });

                // fade in selected division title             
                CM.group.selectAll('g')
                        .transition()
                        .duration(500)
                        .style('opacity', 0);

                // move arc
                d3.select(this)
                        .transition()
                        .duration(750)
                        .call(CM.arcTween, 0.725 * CM.P, 0.775 * CM.P - CM.ArcMargin);

                var gr = d3.select('g#d1-title')
                        .attr('transform', function (d) {
                            return 'rotate(' + (ang - 90) + ')translate(' + 300 + ')';
                        })
                        .select('text')
                        .attr('dx', function (d) {
                            return ang < 180 ? 15 : -15;
                        })
                        .attr('text-anchor', function (d) {
                            return ang < 180 ? 'start' : 'end';
                        })
                        .attr('transform', function (d) {
                            return ang < 180 ? null : 'rotate(180)';
                        });

                // fade out selected division title        
                gr.transition()
                        .delay(500)
                        .duration(500)
                        .style('opacity', 1);

            }
        </script>
    </body>
</html>
